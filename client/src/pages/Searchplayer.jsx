import React, { useEffect, useState } from "react";
import axios from "axios";
import {
  Container,
  Typography,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  Button,
  CircularProgress,
  Snackbar,
  Alert,
  Grid,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  TextField,
  Box,
  Card,
  CardContent,
  Chip,
  Divider,
  IconButton,
  Tooltip,
  Avatar,
  FormHelperText
} from "@mui/material";
import RefreshIcon from '@mui/icons-material/Refresh';
import SearchIcon from '@mui/icons-material/Search';
import PrintIcon from '@mui/icons-material/Print';
import SportsIcon from '@mui/icons-material/Sports';
import SchoolIcon from '@mui/icons-material/School';
import PersonIcon from '@mui/icons-material/Person';
import { useNavigate } from "react-router-dom";

const  Searchplayer = () => {
  const apiBaseUrl = import.meta.env.VITE_API_URL_APPROVEFOOTBAL;
  const [users, setPendingUsers] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [showData, setShowData] = useState(false);

  // States for notifications
  const [snackbar, setSnackbar] = useState({ open: false, message: "", severity: "success" });

  // States for filters
  const [departments, setDepartments] = useState([]);
  const [sportTypes, setSportTypes] = useState([]);
  const [selectedDepartment, setSelectedDepartment] = useState("");
  const [selectedSport, setSelectedSport] = useState("");
  const [categories, setCategories] = useState([]);
  const [selectedCategory, setSelectedCategory] = useState("");
  const [searchFirstName, setSearchFirstName] = useState("");
  const [searchLastName, setSearchLastName] = useState("");
  const navigate = useNavigate();

  // Form validation states
  const [fieldErrors, setFieldErrors] = useState({
    firstName: false,
    lastName: false,
    department: false,
    sport: false,
    category: false
  });
  
  // Error messages for form fields
  const [errorMessages, setErrorMessages] = useState({
    firstName: "",
    lastName: "",
    department: "",
    sport: "",
    category: ""
  });
  
  // State to track if form has been submitted
  const [formSubmitted, setFormSubmitted] = useState(false);

  const sports = [
    { value: "football", label: "р╕Яр╕╕р╕Хр╕Ър╕нр╕е", icon: "тЪ╜" },
    { value: "futsal", label: "р╕Яр╕╕р╕Хр╕Лр╕нр╕е", icon: "тЪ╜" },
    { value: "basketball", label: "р╕Ър╕▓р╕кр╣Ар╕Бр╣Зр╕Хр╕Ър╕нр╕е", icon: "ЁЯПА" },
    { value: "badminton", label: "р╣Бр╕Ър╕Фр╕бр╕┤р╕Щр╕Хр╕▒р╕Щ", icon: "ЁЯП╕" },
    { value: "tabletenis", label: "р╣Ар╕Чр╣Ар╕Ър╕┤р╕ер╣Ар╕Чр╕Щр╕┤р╕к", icon: "ЁЯПУ" },
    { value: "takraw", label: "р╣Ар╕Лр╕Ыр╕▒р╕Бр╕Хр╕░р╕Бр╕гр╣Йр╕н", icon: "ЁЯеО" },
    { value: "volleyball", label: "р╕зр╕нр╕ер╣Ар╕ер╕вр╣Мр╕Ър╕нр╕е", icon: "ЁЯПР" },
    { value: "hooptakraw", label: "р╕Хр╕░р╕Бр╕гр╣Йр╕нр╕ер╕нр╕Фр╕лр╣Ир╕зр╕З", icon: "ЁЯеО" },
    { value: "esport", label: "e-sport", icon: "ЁЯОо" },
    { value: "petanque", label: "р╣Ар╕Ыр╕Хр╕нр╕З", icon: "ЁЯеО" },
  ];

  const fetchDepartments = async () => {
    try {
      const response = await axios.get("http://localhost:5000/api/department");
      setDepartments(response.data);
    } catch (err) {
      console.error("Failed to fetch departments:", err);
      setSnackbar({
        open: true,
        message: "р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕зр╕┤р╕Чр╕вр╕▓р╣Ар╕Вр╕Хр╣Др╕Фр╣Й",
        severity: "error"
      });
    }
  };
  
  const fetchCategoriesBySport = async (sportType) => {
    try {
      const response = await axios.get(`http://localhost:5000/api/sports/category/${sportType}`);
      const categoryData = response.data.categories || response.data;
      setCategories(categoryData);
    } catch (err) {
      console.error("Failed to load categories:", err);
      setCategories([]);
      setSnackbar({
        open: true,
        message: "р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕Бр╕╡р╕мр╕▓р╣Др╕Фр╣Й",
        severity: "error"
      });
    }
  };

  // Validate all fields and show errors for each field
  const validateFields = () => {
    let isValid = true;
    const errors = {
      firstName: false,
      lastName: false,
      department: false,
      sport: false,
      category: false
    };
    
    const messages = {
      firstName: "",
      lastName: "",
      department: "",
      sport: "",
      category: ""
    };
    
    // Check if first name is provided
    if (searchFirstName.trim() === "") {
      errors.firstName = true;
      messages.firstName = "р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Кр╕╖р╣Ир╕н";
      isValid = false;
    } else {
      // Validate firstName format (Thai characters only)
      const thaiRegex = /^[р╕Б-р╣Ы\s]+$/;
      if (!thaiRegex.test(searchFirstName)) {
        errors.firstName = true;
        messages.firstName = "р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Кр╕╖р╣Ир╕нр╣Ар╕Ыр╣Зр╕Щр╕ар╕▓р╕йр╕▓р╣Др╕Чр╕вр╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ";
        isValid = false;
      }
    }

    // Check if last name is provided
    if (searchLastName.trim() === "") {
      errors.lastName = true;
      messages.lastName = "р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е";
      isValid = false;
    } else {
      // Validate lastName format (Thai characters only)
      const thaiRegex = /^[р╕Б-р╣Ы\s]+$/;
      if (!thaiRegex.test(searchLastName)) {
        errors.lastName = true;
        messages.lastName = "р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕ер╣Ар╕Ыр╣Зр╕Щр╕ар╕▓р╕йр╕▓р╣Др╕Чр╕вр╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ";
        isValid = false;
      }
    }

    // Check if department is selected
    if (!selectedDepartment) {
      errors.department = true;
      messages.department = "р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕ер╕╖р╕нр╕Бр╕зр╕┤р╕Чр╕вр╕▓р╣Ар╕Вр╕Х";
      isValid = false;
    }

    // Check if sport is selected
    if (!selectedSport) {
      errors.sport = true;
      messages.sport = "р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕ер╕╖р╕нр╕Бр╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕Бр╕╡р╕мр╕▓";
      isValid = false;
    }

    // Check if category is selected
    if (!selectedCategory) {
      errors.category = true;
      messages.category = "р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕ер╕╖р╕нр╕Бр╕Ыр╕гр╕░р╣Ар╕ар╕Ч";
      isValid = false;
    }

    // Update field errors and messages
    setFieldErrors(errors);
    setErrorMessages(messages);
    
    return isValid;
  };

  const fetchUsers = async () => {
    setFormSubmitted(true);
    
    // Validate fields before proceeding
    if (!validateFields()) {
      return;
    }
    
    setLoading(true);
    setError("");
    try {
      let url = `http://localhost:5000/api/players/searchall`;
      const params = new URLSearchParams();

      if (selectedDepartment) {
        params.append('department', selectedDepartment);
      }
      if (selectedSport) {
        params.append('sport_table', selectedSport);
      }
      if (selectedCategory) {
        params.append('category_id', selectedCategory);
      }
      if (searchFirstName) {
        params.append('fname', searchFirstName.trim());
      }
      if (searchLastName) {
        params.append('lname', searchLastName.trim());
      }

      const queryString = params.toString();
      const fullUrl = queryString ? `${url}?${queryString}` : url;
      
      const response = await axios.get(fullUrl);
      setPendingUsers(response.data);
      setShowData(true);
      
      // Show success message
      if (response.data.length > 0) {
        setSnackbar({
          open: true,
          message: `р╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Щр╕▒р╕Бр╕Бр╕╡р╕мр╕▓ ${response.data.length} р╕гр╕▓р╕вр╕Бр╕▓р╕г`,
          severity: "success"
        });
      } else {
        setSnackbar({
          open: true,
          message: "р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╕Хр╕гр╕Зр╕Бр╕▒р╕Ър╣Ар╕Зр╕╖р╣Ир╕нр╕Щр╣Др╕Вр╕Бр╕▓р╕гр╕Др╣Йр╕Щр╕лр╕▓",
          severity: "info"
        });
      }
    } catch (err) {
      const errorMessage = err.response?.data?.message || err.response?.data || "р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Щр╕▒р╕Бр╕Бр╕╡р╕мр╕▓р╣Др╕Фр╣Й";
      setError(errorMessage);
      console.error("Fetch error:", err);
    } finally {
      setLoading(false);
    }
  };

  const handleSearchDirector = (id) => {
    return () => {
      navigate(`/player/${id}`);
    };
  };

  useEffect(() => {
    fetchDepartments();
  }, []);

  useEffect(() => {
    if (selectedSport) {
      fetchCategoriesBySport(selectedSport);
      // Clear error if sport is selected
      if (formSubmitted) {
        setFieldErrors(prev => ({...prev, sport: false}));
        setErrorMessages(prev => ({...prev, sport: ""}));
      }
    } else {
      setCategories([]);
      setSelectedCategory("");
      // Set error if form has been submitted
      if (formSubmitted) {
        setFieldErrors(prev => ({...prev, sport: true}));
        setErrorMessages(prev => ({...prev, sport: "р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕ер╕╖р╕нр╕Бр╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕Бр╕╡р╕мр╕▓"}));
      }
    }
  }, [selectedSport, formSubmitted]);

  // Handle text field changes
  const handleTextChange = (field, setter) => (e) => {
    const value = e.target.value;
    setter(value);
    
    // Real-time validation if form has been submitted
    if (formSubmitted) {
      if (value.trim() === "") {
        setFieldErrors(prev => ({...prev, [field]: true}));
        setErrorMessages(prev => ({...prev, [field]: field === 'firstName' ? "р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Кр╕╖р╣Ир╕н" : "р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е"}));
      } else {
        const thaiRegex = /^[р╕Б-р╣Ы\s]+$/;
        if (!thaiRegex.test(value)) {
          setFieldErrors(prev => ({...prev, [field]: true}));
          setErrorMessages(prev => ({...prev, [field]: field === 'firstName' ? "р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Кр╕╖р╣Ир╕нр╣Ар╕Ыр╣Зр╕Щр╕ар╕▓р╕йр╕▓р╣Др╕Чр╕вр╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ" : "р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕гр╕нр╕Бр╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕ер╣Ар╕Ыр╣Зр╕Щр╕ар╕▓р╕йр╕▓р╣Др╕Чр╕вр╣Ар╕Чр╣Ир╕▓р╕Щр╕▒р╣Йр╕Щ"}));
        } else {
          setFieldErrors(prev => ({...prev, [field]: false}));
          setErrorMessages(prev => ({...prev, [field]: ""}));
        }
      }
    }
  };

  // Handle select field changes
  const handleSelectChange = (field, setter) => (e) => {
    const value = e.target.value;
    setter(value);
    
    // Clear error for this field if it has a value now
    if (formSubmitted) {
      if (value) {
        setFieldErrors(prev => ({...prev, [field]: false}));
        setErrorMessages(prev => ({...prev, [field]: ""}));
      } else {
        setFieldErrors(prev => ({...prev, [field]: true}));
        let errorMsg = "";
        if (field === 'department') errorMsg = "р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕ер╕╖р╕нр╕Бр╕зр╕┤р╕Чр╕вр╕▓р╣Ар╕Вр╕Х";
        else if (field === 'sport') errorMsg = "р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕ер╕╖р╕нр╕Бр╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕Бр╕╡р╕мр╕▓";
        else if (field === 'category') errorMsg = "р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕ер╕╖р╕нр╕Бр╕Ыр╕гр╕░р╣Ар╕ар╕Ч";
        setErrorMessages(prev => ({...prev, [field]: errorMsg}));
      }
    }
  };

  const handleSearch = () => {
    fetchUsers();
  };

  const handleResetFilters = () => {
    setSelectedDepartment("");
    setSelectedSport("");
    setSelectedCategory("");
    setSearchFirstName("");
    setSearchLastName("");
    setShowData(false);
    setPendingUsers([]);
    setError("");
    setSnackbar({ open: false, message: "", severity: "success" });
    setFieldErrors({
      firstName: false,
      lastName: false,
      department: false,
      sport: false,
      category: false
    });
    setErrorMessages({
      firstName: "",
      lastName: "",
      department: "",
      sport: "",
      category: ""
    });
    setFormSubmitted(false);
  };

  const getSportLabel = (sportValue) => {
    const sport = sports.find(s => s.value === sportValue);
    return sport ? sport.label : sportValue;
  };

  const getSportIcon = (sportValue) => {
    const sport = sports.find(s => s.value === sportValue);
    return sport ? sport.icon : "ЁЯПЕ";
  };

  // Check if search should be disabled
  const isSearchDisabled = loading;

  // Handle Enter key press in search fields
  const handleKeyPress = (event) => {
    if (event.key === 'Enter') {
      handleSearch();
    }
  };

  return (
    <Container maxWidth="xl" sx={{ py: 4 }}>
      <Paper elevation={3} sx={{ p: 3, borderRadius: 2 }}>
        <Box sx={{ mb: 4, textAlign: "center" }}>
          <Typography variant="h4" component="h1" fontWeight="bold" color="primary">
            р╕Юр╕┤р╕бр╕Юр╣Мр╣Ар╕Бр╕╡р╕вр╕гр╕Хр╕┤р╕Щр╕▒р╕Бр╕Бр╕╡р╕мр╕▓
          </Typography>
          <Typography variant="subtitle1" color="text.secondary" sx={{ mt: 1 }}>
            р╕Др╣Йр╕Щр╕лр╕▓р╣Бр╕ер╕░р╕Юр╕┤р╕бр╕Юр╣Мр╕Ър╕▒р╕Хр╕гр╕Ыр╕гр╕░р╕Ир╕│р╕Хр╕▒р╕зр╕Щр╕▒р╕Бр╕Бр╕╡р╕мр╕▓
          </Typography>
        </Box>
        
        <Card variant="outlined" sx={{ mb: 4, backgroundColor: "#f9f9f9" }}>
          <CardContent>
            <Typography variant="h6" sx={{ mb: 2 }} color="primary">
              <SearchIcon sx={{ mr: 1, verticalAlign: "middle" }} />
              р╕Др╣Йр╕Щр╕лр╕▓р╕Щр╕▒р╕Бр╕Бр╕╡р╕мр╕▓
            </Typography>
            
            <Grid container spacing={3}>
              {/* р╕Др╣Йр╕Щр╕лр╕▓р╕Хр╕▓р╕бр╕Кр╕╖р╣Ир╕н */}
              <Grid item xs={12} sm={6} md={3}>
                <TextField
                  fullWidth
                  label="р╕Кр╕╖р╣Ир╕н"
                  variant="outlined"
                  value={searchFirstName}
                  onChange={handleTextChange('firstName', setSearchFirstName)}
                  onKeyPress={handleKeyPress}
                  placeholder="р╕Др╣Йр╕Щр╕лр╕▓р╕Хр╕▓р╕бр╕Кр╕╖р╣Ир╕н"
                  InputProps={{
                    startAdornment: <PersonIcon color="action" sx={{ mr: 1 }} />,
                  }}
                  error={fieldErrors.firstName}
                  helperText={errorMessages.firstName}
                  required
                />
              </Grid>

              {/* р╕Др╣Йр╕Щр╕лр╕▓р╕Хр╕▓р╕бр╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е */}
              <Grid item xs={12} sm={6} md={3}>
                <TextField
                  fullWidth
                  label="р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е"
                  variant="outlined"
                  value={searchLastName}
                  onChange={handleTextChange('lastName', setSearchLastName)}
                  onKeyPress={handleKeyPress}
                  placeholder="р╕Др╣Йр╕Щр╕лр╕▓р╕Хр╕▓р╕бр╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е"
                  InputProps={{
                    startAdornment: <PersonIcon color="action" sx={{ mr: 1 }} />,
                  }}
                  error={fieldErrors.lastName}
                  helperText={errorMessages.lastName}
                  required
                />
              </Grid>

              {/* р╕зр╕┤р╕Чр╕вр╕▓р╣Ар╕Вр╕Х */}
              <Grid item xs={12} sm={6} md={2}>
                <FormControl fullWidth error={fieldErrors.department} required>
                  <InputLabel>р╕зр╕┤р╕Чр╕вр╕▓р╣Ар╕Вр╕Х</InputLabel>
                  <Select
                    value={selectedDepartment}
                    onChange={handleSelectChange('department', setSelectedDepartment)}
                    startAdornment={<SchoolIcon color="action" sx={{ mr: 1 }} />}
                    label="р╕зр╕┤р╕Чр╕вр╕▓р╣Ар╕Вр╕Х"
                  >
                    <MenuItem value="">р╣Ар╕ер╕╖р╕нр╕Бр╕зр╕┤р╕Чр╕вр╕▓р╣Ар╕Вр╕Х</MenuItem>
                    {departments.map((department) => (
                      <MenuItem key={department.id} value={department.name}>
                        {department.name}
                      </MenuItem>
                    ))}
                  </Select>
                  {errorMessages.department && (
                    <FormHelperText>{errorMessages.department}</FormHelperText>
                  )}
                </FormControl>
              </Grid>

              {/* р╕Бр╕╡р╕мр╕▓ */}
              <Grid item xs={12} sm={6} md={2}>
                <FormControl fullWidth error={fieldErrors.sport} required>
                  <InputLabel>р╕Бр╕╡р╕мр╕▓</InputLabel>
                  <Select
                    value={selectedSport}
                    onChange={handleSelectChange('sport', setSelectedSport)}
                    startAdornment={<SportsIcon color="action" sx={{ mr: 1 }} />}
                    label="р╕Бр╕╡р╕мр╕▓"
                  >
                    <MenuItem value="">р╣Ар╕ер╕╖р╕нр╕Бр╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕Бр╕╡р╕мр╕▓</MenuItem>
                    {sports.map((sport) => (
                      <MenuItem key={sport.value} value={sport.value}>
                        {sport.icon} {sport.label}
                      </MenuItem>
                    ))}
                  </Select>
                  {errorMessages.sport && (
                    <FormHelperText>{errorMessages.sport}</FormHelperText>
                  )}
                </FormControl>
              </Grid>

              {/* р╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕Бр╕╡р╕мр╕▓ */}
              <Grid item xs={12} sm={6} md={2}>
                <FormControl fullWidth disabled={!selectedSport} error={fieldErrors.category} required>
                  <InputLabel>р╕Ыр╕гр╕░р╣Ар╕ар╕Ч</InputLabel>
                  <Select
                    value={selectedCategory}
                    onChange={handleSelectChange('category', setSelectedCategory)}
                    label="р╕Ыр╕гр╕░р╣Ар╕ар╕Ч"
                  >
                    <MenuItem value="">р╣Ар╕ер╕╖р╕нр╕Бр╕Ыр╕гр╕░р╣Ар╕ар╕Ч</MenuItem>
                    {categories && Array.isArray(categories) && categories.length > 0 ? (
                      categories.map((cat) => (
                        <MenuItem key={cat.category_id} value={cat.category_id}>
                          {cat.category_name}
                        </MenuItem>
                      ))
                    ) : (
                      <MenuItem value="">
                        <em>р╣Др╕бр╣Ир╕бр╕╡р╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕Бр╕╡р╕мр╕▓</em>
                      </MenuItem>
                    )}
                  </Select>
                  {errorMessages.category && (
                    <FormHelperText>{errorMessages.category}</FormHelperText>
                  )}
                </FormControl>
              </Grid>
            </Grid>

            <Box sx={{ mt: 3, display: "flex", justifyContent: "center", gap: 2 }}>
              <Button
                variant="contained"
                color="primary"
                onClick={handleSearch}
                startIcon={<SearchIcon />}
                sx={{
                  py: 1.5,
                  px: 4,
                  borderRadius: 2,
                  fontWeight: "bold",
                }}
                disabled={isSearchDisabled}
              >
                {loading ? <CircularProgress size={24} color="inherit" /> : "р╕Др╣Йр╕Щр╕лр╕▓"}
              </Button>

              <Button
                variant="outlined"
                color="secondary"
                onClick={handleResetFilters}
                startIcon={<RefreshIcon />}
                sx={{ py: 1.5, px: 4, borderRadius: 2 }}
              >
                р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕Бр╕▓р╕гр╕Др╣Йр╕Щр╕лр╕▓
              </Button>
            </Box>
          </CardContent>
        </Card>

        {/* Snackbar for messages */}
        <Snackbar
          open={snackbar.open || Boolean(error)}
          autoHideDuration={6000}
          onClose={() => {
            setSnackbar({ ...snackbar, open: false });
            setError("");
          }}
          anchorOrigin={{ vertical: "top", horizontal: "center" }}
        >
          <Alert 
            severity={error ? "error" : snackbar.severity} 
            variant="filled"
            onClose={() => {
              setSnackbar({ ...snackbar, open: false });
              setError("");
            }}
          >
            {error || snackbar.message}
          </Alert>
        </Snackbar>

        {loading && (
          <Box sx={{ display: "flex", justifyContent: "center", my: 4 }}>
            <CircularProgress />
          </Box>
        )}

        {showData && !loading && (
          <Card variant="outlined" sx={{ mt: 3 }}>
            <CardContent>
              <Box sx={{ display: "flex", justifyContent: "space-between", mb: 2, alignItems: "center" }}>
                <Typography variant="h6" color="primary">
                  р╕Ьр╕ер╕Бр╕▓р╕гр╕Др╣Йр╕Щр╕лр╕▓
                </Typography>
                <Chip 
                  label={`р╕Юр╕Ър╕Щр╕▒р╕Бр╕Бр╕╡р╕мр╕▓ ${users.length} р╕Др╕Щ`} 
                  color={users.length > 0 ? "primary" : "default"} 
                  variant="outlined" 
                />
              </Box>
              
              <Divider sx={{ mb: 2 }} />
              
              <TableContainer component={Paper} variant="outlined">
                <Table sx={{ minWidth: 650 }}>
                  <TableHead sx={{ backgroundColor: "#f5f5f5" }}>
                    <TableRow>
                      <TableCell>р╕ер╕│р╕Фр╕▒р╕Ъ</TableCell>
                      <TableCell>р╕Кр╕╖р╣Ир╕н-р╕Щр╕▓р╕бр╕кр╕Бр╕╕р╕е</TableCell>
                      <TableCell>р╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕Бр╕╡р╕мр╕▓</TableCell>
                      <TableCell>р╕Ыр╕гр╕░р╣Ар╕ар╕Ч</TableCell>
                      <TableCell>р╕зр╕┤р╕Чр╕вр╕▓р╣Ар╕Вр╕Х</TableCell>
                      <TableCell align="center">р╕Юр╕┤р╕бр╕Юр╣М</TableCell>
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {users.length === 0 ? (
                      <TableRow>
                        <TableCell colSpan={6} align="center" sx={{ py: 3 }}>
                          <Typography color="text.secondary">р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Щр╕▒р╕Бр╕Бр╕╡р╕мр╕▓</Typography>
                        </TableCell>
                      </TableRow>
                    ) : (
                      users.map((user, index) => (
                        <TableRow 
                          key={user.id || index}
                          sx={{ '&:hover': { backgroundColor: '#f5f9ff' } }}
                        >
                          <TableCell>{index + 1}</TableCell>
                          <TableCell>
                            <Box sx={{ display: "flex", alignItems: "center", gap: 1 }}>
                              <Avatar sx={{ width: 32, height: 32, bgcolor: `hsl(${index * 40}, 70%, 60%)` }}>
                                {user.fname ? user.fname.charAt(0) : "?"}
                              </Avatar>
                              <Typography>
                                {user.fname} {user.lname}
                              </Typography>
                            </Box>
                          </TableCell>
                          <TableCell>
                            <Chip 
                              icon={<Typography>{getSportIcon(user.sport_table)}</Typography>}
                              label={getSportLabel(user.sport_table)} 
                              variant="outlined" 
                              size="small"
                            />
                          </TableCell>
                          <TableCell>{user.category_name || "-"}</TableCell>
                          <TableCell>{user.department || "-"}</TableCell>
                          <TableCell align="center">
                            <Tooltip title="р╕Юр╕┤р╕бр╕Юр╣Мр╕Ър╕▒р╕Хр╕гр╕Ыр╕гр╕░р╕Ир╕│р╕Хр╕▒р╕з">
                              <Button
                                variant="contained"
                                color="primary"
                                onClick={handleSearchDirector(user.registration_id)}
                                sx={{
                                  textTransform: "none",
                                  borderRadius: 2,
                                }}
                                startIcon={<PrintIcon />}
                              >
                                р╕Юр╕┤р╕бр╕Юр╣Мр╕Ър╕▒р╕Хр╕г
                              </Button>
                            </Tooltip>
                          </TableCell>
                        </TableRow>
                      ))
                    )}
                  </TableBody>
                </Table>
              </TableContainer>
            </CardContent>
          </Card>
        )}
      </Paper>
    </Container>
  );
};

export default Searchplayer;